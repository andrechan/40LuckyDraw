<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå®šä¹‰æŠ½å¥–ç¨‹åº</title>
    <style>
        * { box-sizing: border-box; margin:0; padding:0; font-family: 'Arial', sans-serif; }
        body { background: linear-gradient(120deg, #6a11cb 0%, #2575fc 100%); min-height:100vh; padding:12px; padding-bottom:180px; }
        
        /* è¾“å…¥é¡µé¢æ ·å¼ */
        #input-page { display:block; max-width:800px; margin:0 auto; padding:20px; background:rgba(255,255,255,0.9); border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
        #input-page h2 { text-align:center; color:#333; margin-bottom:15px; }
        #config-input { width:100%; height:250px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:vertical; font-size:14px; margin-bottom:10px; }
        #submit-config { display:block; width:100%; max-width:200px; margin:0 auto; padding:10px; background:#2575fc; color:white; border:none; border-radius:6px; font-size:16px; font-weight:bold; cursor:pointer; }
        
        /* æŠ½å¥–ç•Œé¢åˆå§‹éšè— */
        .header-container, .main-content, .bottom-selected-bar { display:none; }
        
        /* æŠ½å¥–ç•Œé¢æ ·å¼ï¼ˆé€‚é…è‡ªå®šä¹‰é…ç½®ï¼‰ */
        .main-title { font-size:28px; color:white; text-shadow:0 2px 4px rgba(0,0,0,0.3); font-weight:bold; margin:0 0 15px; text-align:center; }
        .top-bar { display:flex; align-items:center; justify-content:center; gap:15px; margin-bottom:12px; flex-wrap:wrap; }
        .current-round { font-size:20px; color:#ffcc00; font-weight:bold; text-shadow:0 1px 2px rgba(0,0,0,0.2); white-space:nowrap; }
        .start-btn { padding:8px 30px; font-size:13px; height:40px; display:flex; align-items:center; justify-content:center; background:#ffcc00; color:#333; border:none; border-radius:6px; font-weight:bold; cursor:pointer; white-space:nowrap; }
        .member-btn { background:#4CAF50; color:white; padding:8px 15px; border:none; border-radius:6px; font-size:13px; font-weight:bold; cursor:pointer; height:40px; white-space:nowrap; }
        .end-round-btn { background:#ff4444; color:white; display:inline-block; padding:8px 15px; border:none; border-radius:6px; font-size:13px; font-weight:bold; height:40px; white-space:nowrap; cursor:not-allowed; opacity:0.6; }
        .end-round-btn:enabled { cursor:pointer; opacity:1; }
        .bottom-clear-btn { position:absolute; right:10px; top:12px; padding:4px 8px; background:#ff4444; color:white; border:none; border-radius:3px; font-size:12px; cursor:pointer; }
        .main-content { display:block; max-width:100%; margin:0 auto; padding:0 12px; }
        .left-content { width:100%; }
        .lottery-container { background:rgba(255,255,255,0.9); padding:15px; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); display:block; margin-bottom:12px; }
        .scroll-container { width:100%; height:90px; overflow:hidden; position:relative; border:2px solid #2575fc; border-radius:8px; background:#f8f8f8; }
        .scroll-highlight { position:absolute; top:0; left:50%; transform:translateX(-50%); width:120px; height:100%; background:rgba(255,0,0,0.2); border-left:2px solid red; border-right:2px solid red; pointer-events:none; display:none; }
        .scroll-list { display:flex; position:absolute; left:0; top:0; white-space:nowrap; }
        .scroll-item { width:120px; padding:0 8px; line-height:90px; font-size:20px; font-weight:bold; text-align:center; box-sizing:border-box; overflow:hidden; text-overflow:ellipsis; }
        .center-flip-card { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:280px; height:160px; max-width:calc(100vw -30px); max-height:calc((100vw -30px)*9/16); perspective:1200px; z-index:10000; }
        .center-flip-inner { position:relative; width:100%; height:100%; text-align:center; transition:transform 0.6s; transform-style:preserve-3d; }
        .center-flip-front, .center-flip-back { position:absolute; width:100%; height:100%; backface-visibility:hidden; border-radius:15px; display:flex; align-items:center; justify-content:center; font-weight:bold; }
        .center-flip-front { background:#f0f0f0; color:#333; font-size:22px; }
        .center-flip-back { background:#2575fc; color:white; transform:rotateY(180deg); font-size:clamp(16px,4vw,24px); padding:10px; white-space:pre-line; }
        .center-flip-card.show .center-flip-inner { transform:rotateY(180deg); }
        .bottom-selected-bar { position:fixed; bottom:0; left:0; width:100%; background:rgba(255,255,255,0.95); padding:10px 10px 15px; box-shadow:0 -2px 10px rgba(0,0,0,0.1); z-index:9999; min-height:100px; position:relative; }
        .current-round-temp-winners { margin-bottom:8px; font-size:14px; color:#666; }
        .round-winners-row { margin-bottom:6px; font-size:14px; line-height:1.5; }
        .round-title { font-weight:bold; color:#2575fc; margin-right:8px; }
        .winners-list { color:#333; }
        .modal { display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
        .modal-content { background:white; margin:10% auto; padding:20px; border-radius:10px; width:90%; max-width:400px; position:relative; max-height:80vh; overflow-y:auto; }
        .close-modal { position:absolute; right:15px; top:10px; font-size:24px; cursor:pointer; color:#666; }
        .modal-title { font-size:18px; margin-bottom:15px; color:#333; text-align:center; font-weight:bold; }
        .modal-members-textarea { width:100%; height:180px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none; font-size:14px; margin-bottom:10px; }
        .modal-save-btn { display:block; margin:15px auto 0; padding:8px 16px; border:none; border-radius:6px; background:#2575fc; color:white; cursor:pointer; font-size:14px; }
    </style>
</head>
<body>
    <!-- è¾“å…¥é…ç½®é¡µé¢ï¼ˆåˆå§‹æ˜¾ç¤ºï¼‰ -->
    <div id="input-page">
        <h2>æŠ½å¥–é…ç½®è¾“å…¥</h2>
        <textarea id="config-input" placeholder="è¯·è¾“å…¥é…ç½®ï¼ˆæ ¼å¼ç¤ºä¾‹ï¼‰ï¼š
Title:è¯æ­¡å¤§æŠ½ç
round 1 name:ä¸‰ç
round 2 name:äºŒç
last round name:é ­ç
the rest members:å®‰æ…°ç
lucky draw effect time (seconds):3
Members list:
John
Michael
Albert
Jimmy"></textarea>
        <button id="submit-config">æäº¤é…ç½®</button>
    </div>

    <!-- æŠ½å¥–ç•Œé¢ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div class="header-container" style="display:none;">
        <h1 class="main-title"></h1>
        <div class="top-bar">
            <div class="current-round" id="current-round"></div>
            <button class="start-btn" id="start-btn">é–‹å§‹æŠ½ç</button>
            <button class="member-btn" id="view-members-btn">åƒèˆ‡åå–®</button>
            <button class="end-round-btn" id="end-round-btn" disabled>çµæŸç•¶å‰è¼ªæ¬¡</button>
        </div>
    </div>

    <div class="main-content" style="display:none;">
        <div class="left-content">
            <div id="scroll-container" class="lottery-container">
                <div class="scroll-container">
                    <div class="scroll-highlight"></div>
                    <div class="scroll-list" id="scroll-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="center-flip-card" class="center-flip-card">
        <div class="center-flip-inner">
            <div class="center-flip-front">ä¸­ç</div>
            <div class="center-flip-back" id="center-flip-back"></div>
        </div>
    </div>

    <div class="bottom-selected-bar" style="display:none;">
        <div class="current-round-temp-winners" id="current-round-temp-winners"></div>
        <div id="round-winners-container"></div> <!-- åŠ¨æ€ç”Ÿæˆè½®æ¬¡è¡Œ -->
        <button class="bottom-clear-btn" id="bottom-clear-btn">æ¸…ç©º</button>
    </div>

    <div id="members-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 class="modal-title">åƒèˆ‡åå–®ï¼ˆ*æ•¸é‡å°æ‡‰è¼ªæ¬¡ï¼‰</h2>
            <textarea class="modal-members-textarea" id="modal-members-textarea" placeholder="æ¯è¡Œä¸€å€‹åå­—ï¼Œä¸­çè€…åŠ å°æ‡‰æ•¸é‡*"></textarea>
            <button class="modal-save-btn" id="modal-save-members">å„²å­˜ä¿®æ”¹</button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡ï¼ˆå°†è¢«ç”¨æˆ·é…ç½®è¦†ç›–ï¼‰
        let allRounds = [];
        let æŠ½å¥–è½®æ¬¡ = [];
        let allNames = [];
        let remainingNames = [];
        let effectTimeMs = 3000;
        let restMemberName = "";
        let currentRoundIndex = 0;
        let currentRoundTempWinners = [];
        let roundWinnersMap = {};
        const ITEM_WIDTH = 120;

        // DOMå…ƒç´ 
        const configInput = document.getElementById('config-input');
        const submitConfigBtn = document.getElementById('submit-config');
        const scrollHighlight = document.querySelector('.scroll-highlight');
        const viewMembersBtn = document.getElementById('view-members-btn');
        const membersModal = document.getElementById('members-modal');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        const modalMembersTextarea = document.getElementById('modal-members-textarea');
        const modalSaveMembersBtn = document.getElementById('modal-save-members');
        const centerFlipCard = document.getElementById('center-flip-card');
        const centerFlipBack = document.getElementById('center-flip-back');
        const currentRoundTempWinnersEl = document.getElementById('current-round-temp-winners');
        const bottomClearBtn = document.getElementById('bottom-clear-btn');
        const startBtn = document.getElementById('start-btn');
        const endRoundBtn = document.getElementById('end-round-btn');
        const currentRoundEl = document.getElementById('current-round');
        const roundWinnersContainer = document.getElementById('round-winners-container');

        // é…ç½®è§£æå‡½æ•°
        function parseConfig(inputText) {
            const lines = inputText.split('\n').map(line => line.trim()).filter(line => line !== '');
            let title = '';
            const roundNames = [];
            let restMember = '';
            let effectTime = 3;
            const members = [];
            let isCollectingMembers = false;

            for (const line of lines) {
                if (line.startsWith('Title:')) title = line.slice('Title:'.length).trim();
                else if (line.startsWith('round ') && line.includes(' name:')) roundNames.push(line.slice(line.indexOf('name:')+5).trim());
                else if (line.startsWith('last round name:')) roundNames.push(line.slice('last round name:'.length).trim());
                else if (line.startsWith('the rest members:')) restMember = line.slice('the rest members:'.length).trim();
                else if (line.startsWith('lucky draw effect time:')) effectTime = parseInt(line.slice('lucky draw effect time:'.length).trim(),10);
                else if (line === 'Members list:') isCollectingMembers = true;
                else if (isCollectingMembers) members.push(line);
console.log(line.startsWith('lucky draw effect time:'));
console.log(line.slice('lucky draw effect time:'.length).trim());
            }
            // é”™è¯¯éªŒè¯
            const errors = [];
            if (!title) errors.push('ç¼ºå°‘æ ‡é¢˜ï¼ˆTitleé¡¹ï¼‰');
            if (roundNames.length === 0) errors.push('ç¼ºå°‘è½®æ¬¡åç§°ï¼ˆround x name/last round nameé¡¹ï¼‰');
            if (!restMember) errors.push('ç¼ºå°‘å®‰æ…°å¥–åç§°ï¼ˆthe rest membersé¡¹ï¼‰');
			console.log(effectTime);
            if (isNaN(effectTime) || effectTime <=0) errors.push('æŠ½å¥–æ—¶é•¿å¿…é¡»ä¸ºæ­£æ•´æ•°');
            if (members.length ===0) errors.push('ç¼ºå°‘æˆå‘˜åˆ—è¡¨ï¼ˆMembers listé¡¹ï¼‰');
            
            if (errors.length>0) return { success:false, error:errors.join('\n') };
            
            // å¤„ç†æˆå‘˜åˆ—è¡¨
            const uniqueMembers = [...new Set(members.map(m=>m.trim()))].filter(m=>m!=='');
            if (uniqueMembers.length===0) return { success:false, error:'æˆå‘˜åˆ—è¡¨ä¸èƒ½ä¸ºç©º' };

            return {
                success:true,
                data:{ title, roundNames, restMember, effectTime, members:uniqueMembers }
            };
        }

        // åŠ¨æ€ç”Ÿæˆè½®æ¬¡è¡Œ
        function generateRoundWinnersRows() {
            roundWinnersContainer.innerHTML = '';
            allRounds.forEach(round => {
                const row = document.createElement('div');
                row.className = 'round-winners-row';
                row.innerHTML = `<span class="round-title">${round}ï¼š</span><span class="winners-list" id="winners-${round}">æš«ç„¡</span>`;
                roundWinnersContainer.appendChild(row);
            });
        }

        // æ›´æ–°è½®æ¬¡æ˜¾ç¤º
        function updateCurrentRoundDisplay() {
            currentRoundEl.textContent = currentRoundIndex < æŠ½å¥–è½®æ¬¡.length ? `ç•¶å‰è¼ªæ¬¡ï¼š${æŠ½å¥–è½®æ¬¡[currentRoundIndex]}` : 'æ‰€æœ‰è¼ªæ¬¡å·²å®Œæˆ';
        }

        // æ›´æ–°ä¸´æ—¶ä¸­å¥–è€…æ˜¾ç¤º
        function updateCurrentRoundTempWinnersDisplay() {
            currentRoundTempWinnersEl.textContent = currentRoundTempWinners.length===0 ? '' : 
                `ç•¶å‰è¼ªæ¬¡ï¼ˆ${æŠ½å¥–è½®æ¬¡[currentRoundIndex]}ï¼‰è‡¨æ™‚ä¸­çè€…ï¼š${currentRoundTempWinners.map((n,i)=>`${i+1}. ${n}`).join('ã€')}`;
        }

        // æ›´æ–°åº•éƒ¨ä¸­å¥–åå•
        function updateBottomWinnersDisplay() {
            allRounds.forEach(round => {
                const winnersEl = document.getElementById(`winners-${round}`);
                winnersEl.textContent = roundWinnersMap[round]?.length===0 ? 'æš«ç„¡' : 
                    roundWinnersMap[round].map((n,i)=>`${i+1}. ${n}`).join('ã€');
            });
        }

        // é‡ç½®æŠ½å¥–çŠ¶æ€
        function resetLotteryState() {
            currentRoundIndex = 0;
            currentRoundTempWinners = [];
            roundWinnersMap = {};
            allRounds.forEach(round => roundWinnersMap[round] = []);
            
            remainingNames = [...allNames];
            updateCurrentRoundDisplay();
            updateCurrentRoundTempWinnersDisplay();
            initScroll();
            endRoundBtn.disabled = true;
            startBtn.disabled = currentRoundIndex >= æŠ½å¥–è½®æ¬¡.length;
        }

        // åˆå§‹åŒ–æ»šåŠ¨åˆ—è¡¨
        function initScroll() {
            const scrollList = document.getElementById('scroll-list');
            scrollList.innerHTML = '';
            if (remainingNames.length===0) return;
            
            const repeatedList = [...remainingNames, ...remainingNames, ...remainingNames];
            repeatedList.forEach(name => {
                const item = document.createElement('div');
                item.className = 'scroll-item';
                item.textContent = name;
                scrollList.appendChild(item);
            });
        }

        // æäº¤é…ç½®å¤„ç†
        submitConfigBtn.addEventListener('click', () => {
            const inputText = configInput.value.trim();
            if (!inputText) { alert('è¯·è¾“å…¥é…ç½®å†…å®¹'); return; }
            
            const parseResult = parseConfig(inputText);
            if (!parseResult.success) { alert(parseResult.error); return; }
            
            const { title, roundNames, restMember, effectTime, members } = parseResult.data;
            
            // æ›´æ–°å…¨å±€å˜é‡
            allRounds = [...roundNames, restMember];
            æŠ½å¥–è½®æ¬¡ = roundNames;
            allNames = members;
            remainingNames = [...members];
            effectTimeMs = effectTime * 1000;
            restMemberName = restMember;
            
            // æ›´æ–°ç•Œé¢
            document.querySelector('.main-title').textContent = title;
            generateRoundWinnersRows();
            resetLotteryState();
            
            // åˆ‡æ¢æ˜¾ç¤º
            document.getElementById('input-page').style.display = 'none';
            document.querySelector('.header-container').style.display = 'block';
            document.querySelector('.main-content').style.display = 'block';
            document.querySelector('.bottom-selected-bar').style.display = 'block';
        });

        // å‚ä¸åå•æ¨¡æ€æ¡†é€»è¾‘
        viewMembersBtn.addEventListener('click', () => {
            const membersWithMark = allNames.map(name => {
                let stars = '';
                allRounds.forEach((round, idx) => { if (roundWinnersMap[round].includes(name)) stars = '*'.repeat(idx+1); });
                return `${stars}${name}`;
            }).join('\n');
            modalMembersTextarea.value = membersWithMark;
            membersModal.style.display = 'block';
        });

        // å…³é—­æ¨¡æ€æ¡†
        closeModalBtns.forEach(btn => btn.addEventListener('click', () => membersModal.style.display = 'none'));
        window.addEventListener('click', e => e.target === membersModal && (membersModal.style.display = 'none'));

        // ä¿å­˜æˆå‘˜ä¿®æ”¹
        modalSaveMembersBtn.addEventListener('click', () => {
            const lines = modalMembersTextarea.value.split('\n').map(line => line.trim()).filter(line => line!=='');
            const newNames = [];
            roundWinnersMap = {};
            allRounds.forEach(round => roundWinnersMap[round] = []);
            
            lines.forEach(line => {
                const starCount = (line.match(/^\*+/g)||[''])[0].length;
                const name = line.replace(/^\*+/,'').trim();
                if (!name) return;
                newNames.push(name);
                if (starCount>0 && starCount<=æŠ½å¥–è½®æ¬¡.length) roundWinnersMap[æŠ½å¥–è½®æ¬¡[starCount-1]].push(name);
            });
            
            allNames = [...new Set(newNames)];
            resetLotteryState();
            updateBottomWinnersDisplay();
            membersModal.style.display = 'none';
            alert('åƒèˆ‡åå–®å·²æ›´æ–°ï¼');
        });

        // æ¸…ç©ºæŒ‰é’®é€»è¾‘
        bottomClearBtn.addEventListener('click', () => {
            if (confirm('ç¢ºèªæ¸…ç©ºæ‰€æœ‰ä¸­çè¨˜éŒ„ï¼Ÿ')) {
                resetLotteryState();
                updateBottomWinnersDisplay();
                alert('å·²æ¸…ç©ºæ‰€æœ‰ä¸­çè¨˜éŒ„ï¼');
            }
        });

        // å¼€å§‹æŠ½å¥–é€»è¾‘
        startBtn.addEventListener('click', () => {
            if (currentRoundIndex >= æŠ½å¥–è½®æ¬¡.length) { alert('æ‰€æœ‰è¼ªæ¬¡å·²å®Œæˆï¼'); return; }
            if (remainingNames.length ===0) { alert('ç•¶å‰è¼ªæ¬¡ç„¡å¯åƒèˆ‡äººå“¡ï¼'); return; }
            
            startBtn.disabled = true;
            scrollHighlight.style.display = 'block';
            
            let scrollPosition = 0;
            const scrollList = document.getElementById('scroll-list');
            const scrollInterval = setInterval(() => {
                scrollPosition +=18;
                if (scrollPosition >= remainingNames.length*ITEM_WIDTH*2) scrollPosition=0;
                scrollList.style.transform = `translateX(-${scrollPosition}px)`;
            },16);
            
            setTimeout(() => {
                clearInterval(scrollInterval);
                stopScroll(scrollPosition);
            }, effectTimeMs);
        });

        // åœæ­¢æ»šåŠ¨é€»è¾‘
        function stopScroll(scrollPosition) {
            const scrollList = document.getElementById('scroll-list');
            if (remainingNames.length===0) { startBtn.disabled=false; return; }
            
            const normalizedPos = scrollPosition % (remainingNames.length*ITEM_WIDTH);
            const targetIndex = Math.floor(normalizedPos/ITEM_WIDTH) % remainingNames.length;
            const targetScrollPos = targetIndex*ITEM_WIDTH + (scrollPosition - normalizedPos);
            
            scrollList.style.transform = `translateX(-${targetScrollPos}px)`;
            scrollHighlight.style.display = 'none';
            
            const selectedName = remainingNames[targetIndex];
            remainingNames = remainingNames.filter(n => n !== selectedName);
            currentRoundTempWinners.push(selectedName);
            
            initScroll();
            showCenterFlipResult(selectedName);
            updateCurrentRoundTempWinnersDisplay();
            endRoundBtn.disabled = false;
            startBtn.disabled = false;
        }

        // æ˜¾ç¤ºä¸­å¥–ç»“æœ
        function showCenterFlipResult(name) {
            centerFlipBack.textContent = name;
            centerFlipCard.style.display = 'block';
            setTimeout(() => centerFlipCard.classList.add('show'),100);
            setTimeout(() => {
                centerFlipCard.classList.remove('show');
                setTimeout(() => centerFlipCard.style.display='none',600);
            },2000);
        }

        // ç»“æŸè½®æ¬¡é€»è¾‘
        endRoundBtn.addEventListener('click', () => {
            if (currentRoundTempWinners.length===0) { alert('è«‹è‡³å°‘æŠ½å–ä¸€åä¸­çè€…ï¼'); return; }
            if (!confirm('ç¢ºèªçµæŸç•¶å‰è¼ªæ¬¡ï¼Ÿ')) return;
            
            const currentRound = æŠ½å¥–è½®æ¬¡[currentRoundIndex];
            roundWinnersMap[currentRound] = [...currentRoundTempWinners];
            
            updateBottomWinnersDisplay();
            currentRoundTempWinners = [];
            updateCurrentRoundTempWinnersDisplay();
            endRoundBtn.disabled = true;
            
            currentRoundIndex++;
            updateCurrentRoundDisplay();
            
            if (currentRoundIndex >= æŠ½å¥–è½®æ¬¡.length) {
                roundWinnersMap[restMemberName] = [...remainingNames];
                updateBottomWinnersDisplay();
                startBtn.disabled = true;
                alert(`ğŸ‰ æ‰€æœ‰è¼ªæ¬¡å®Œæˆï¼æœªä¸­çè€…è‡ªå‹•æˆç‚º${restMemberName}å¾—ä¸»ï¼`);
            } else {
                alert(`âœ… å·²å®Œæˆ${æŠ½å¥–è½®æ¬¡[currentRoundIndex-1]}ï¼Œå³å°‡é€²å…¥${æŠ½å¥–è½®æ¬¡[currentRoundIndex]}ï¼`);
            }
        });
    </script>
</body>
</html>